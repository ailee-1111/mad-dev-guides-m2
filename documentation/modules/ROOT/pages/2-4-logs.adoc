= Logs

Kubernetes/OpenShift 클러스터 전체에서 로그 수집 및 보기를 수행하는 다양한 "프로덕션 준비" 방법이 있습니다.  많은 사람들이 ELK(ElasticSearch, Logstash, Kibana) 또는 EFK(ElasticSearch, FluentD, Kibana)를 좋아합니다.
여기서 초점은 포드 내에서 실행되는 애플리케이션의 동작을 이해하는 데 도움을 주기 위해 개발자가 액세스해야 하는 작업에 있습니다.

애플리케이션(배포)이 실행 중인지 확인하세요.:

[#create-deployment]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
        env: dev
    spec:
      containers:
      - name: myapp
        image: quay.io/rhdevelopers/myboot:v1
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
EOF
----

3개의 복제본(애플리케이션의 3개 포드/인스턴스)을 실행하고 있는지 확인하세요.:

[#logs-get-replicas]
[.console-input]
[source, bash]
----
oc get deployment my-deployment -o json | jq '.status.replicas'
----

[.console-output]
[source,bash]
----
3
----

그렇지 않은 경우 최대 3개까지 확장하세요.:

[#logs-scale-replicas]
[.console-input]
[source, bash]
----
oc scale --replicas=3 deployment/my-deployment
----

[#logs-scale-replicas]
[.console-input]
[source, bash]
----
oc get pod
----


[.console-output]
[source,bash]
----
NAME                             READY   STATUS    RESTARTS   AGE
my-deployment-5dc67997c7-5bq4n   1/1     Running   0          34s
my-deployment-5dc67997c7-m7z9f   1/1     Running   0          34s
my-deployment-5dc67997c7-s4jc6   1/1     Running   0          34s
----

[#logs-log-deployment]
[.console-input]
[source, bash]
----
oc logs my-deployment-5dc67997c7-m7z9f
----

IMPORTANT: pod 이름( my-deployment-5dc67997c7-m7z9f)은 각 실습 클러스터에서 조회 된 값으로 변경하여 입력하세요.


[.console-output]
[source]
----
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v1.5.3.RELEASE)

----

NOTE: `-f` 매개변수를 사용하여 로그를 실시간으로 출력할 수 있습니다.

[#logs-log-deployment-follow]
[.console-input]
[source, bash]
----
oc logs my-deployment-5dc67997c7-m7z9f -f
----

그리고 다른 터미널에서 실행하세요.:

[.console-input]
[source,bash]
----
oc exec -it my-deployment-5dc67997c7-m7z9f /bin/bash
----

IMPORTANT: pod 이름( my-deployment-5dc67997c7-m7z9f)은 각 실습 클러스터에서 조회 된 값으로 변경하여 입력하세요.

[.console-input]
[source,bash]
----
curl localhost:8080
----

[.console-output]
[source,bash]
----
Aloha from my-deployment-5dc67997c7-m7z9f
----

'my-deployment'에 대한 서비스를 배포하세요.:

[#create-service]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: the-service
spec:
  selector:
    app: myapp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: LoadBalancer
EOF
----

다른 터미널에서 해당 서비스를 반복하고 curl 하세요.:

:section-k8s: logs
:service-exposed: the-service
include::partial$env-curl.adoc[]

Start sending the request in a loop:

include::partial$loop.adoc[]

그런 다음 Stern을 사용하여 모든 Pod의 로그를 봅니다.:

[#stern-my-deployment]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
stern my-deployment
----

[.console-output]
[source,bash]
----
my-deployment-5dc67997c7-5bq4n myapp Aloha from my-deployment-5dc67997c7-5bq4n
my-deployment-5dc67997c7-m7z9f myapp Aloha from my-deployment-5dc67997c7-m7z9f
my-deployment-5dc67997c7-s4jc6 myapp Aloha from my-deployment-5dc67997c7-s4jc6
my-deployment-5dc67997c7-s4jc6 myapp Aloha from my-deployment-5dc67997c7-s4jc6
----

또 다른 옵션은 https://github.com/boz/kail[kail]입니다.:

Kail을 설치합니다.:

[#install-kail]
[.console-input]
[source, bash]
----
brew tap boz/repo
----

[#install-kail]
[.console-input]
[source, bash]
----
brew install boz/repo/kail
----

Kail을 실행합니다.:

[#run-kail]
[.console-input]
[source, bash]
----
kail --deploy=my-deployment -c myapp --since=1h
----

[TIP]
====
실패한 포드에서 로그를 가져오려면 '-p'를 사용하세요.

[.console-input]
[source,bash]
----
oc logs my-deployment-5dc67997c7-s4jc6 -p 
----
====



== Clean Up

[#clean-up]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete service the-service
----

[#clean-up]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete deployment my-deployment
----
