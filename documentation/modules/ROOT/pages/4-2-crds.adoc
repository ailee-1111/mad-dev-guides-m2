= Operators


Operator는 기본 Kubernetes API에 제공되는 확장을 관리하기 위해 자동화된 컨트롤러를 설치하여 Kubernetes 클러스터의 기능을 확장하는 방법입니다.
이 섹션에서는 운영자가 이를 수행하기 위해 Kubernetes API와 상호 작용하는 방법을 자세히 살펴보겠습니다.

.Operators in the Real World
****
마스터 클래스에서 이 튜토리얼을 시연할 때 Openshift에서 Kafka Operator를 보여주는 것이 좋습니다(대략 <<OpenShift용 Kafka,여기>> 설명 참조).  OpenShift 클러스터에 표시할 때의 핵심 사항:

. OperatorHub를 사용하여 얼마나 많은 Operator가 있는지 확인하세요.  +
. 클러스터에 Kafka 지원(즉, 앞으로 보게 될 CRD)을 추가하려면 'AMQStreams' 또는 'Strimzi' Operator를 설치하세요. + 
. Operator가 설치되면 'Kafka' CR을 설치할 네임스페이스를 선택합니다. +
. Operator Perspective에서 Operator가 생성 중인 Kafka를 표시합니다.

튜토리얼의 이 섹션에서는 직접 만든 장난감 "피자 오퍼레이터"를 사용하여 오퍼레이터의 이러한 측면을 시연해 보겠습니다.
****

== Preparation

=== Namespace 준비

Operator 배포를 수용할 네임스페이스와 Operator가 작동할 `CustomResources`가 필요합니다.



[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc new-project operator-%userid%
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
namespace/operator-%userid% created
----

NOTE: `oc new-project operator-%userid%` : operator-%userid%라는 새 프로젝트(네임스페이스)를 생성합니다.



[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc project operator-%userid%
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Now using project "operator-%userid%" on server "https://172.30.0.1:443".
----

NOTE: `oc project operator-%userid%` : 현재 활성화된 컨텍스트의 기본 네임스페이스를 operator-%userid%로 변경합니다.



네임스페이스에서 아무것도 실행되고 있지 않은지 확인하세요.

[#no-resources-resource]
[.console-input]
[source, bash]
----
oc get all
----

[.console-output]
[source,bash]
----
No resources found in myspace namespace.
----





=== Watch

아직 열려 있지 않은 경우 터미널을 열어(*Terminal#2) 현재 네임스페이스의 Pod에서 무슨 일이 일어나고 있는지 확인하는 것이 좋습니다.



[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc project operator-%userid%
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Now using project "operator-%userid%" on server "https://172.30.0.1:443".
----

NOTE: `oc project operator-%userid%` : 현재 활성화된 컨텍스트의 기본 네임스페이스를 operator-%userid%로 변경합니다.



[.console-input]
[source,bash,subs="+macros,+attributes"]
----
watch -n 1 "oc get pods -o wide \
  | awk '{print \$1 \" \" \$2 \" \" \$3 \" \" \$5 \" \" \$7}' | column -t"
----


TIP: `-o wide` 옵션을 사용하면 포드가 예약된 노드를 볼 수 있습니다. +
줄이 너무 길어지는 것을 방지하기 위해 `awk`와 `column`을 사용하여 원하는 열만 가져오고 형식을 지정합니다.







=== Logs



== CRDs

사용자 정의 리소스는 API를 확장합니다.

사용자 정의 컨트롤러는 원하는 상태를 지속적으로 유지 관리하여 상태를 모니터링하고 구성과 일치하도록 리소스를 조정하는 기능을 제공합니다.

https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/

https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/

버전 1.7CRD의 사용자 정의 리소스 정의(CRD)는 Kubernetes API를 확장합니다.  우리는 이러한 API 리소스를 쉽게 볼 수 있습니다. 

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc api-resources
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
NAME                              SHORTNAMES   APIVERSION                             NAMESPACED   KIND
bindings                                       v1                                     true         Binding
componentstatuses                 cs           v1                                     false        ComponentStatus
configmaps                        cm           v1                                     true         ConfigMap
endpoints                         ep           v1                                     true         Endpoint
... #<.>
----
NOTE: <.> 이 목록은 잘렸습니다.

목록에는 '배포'와 같이 이미 배운 리소스 중 일부가 있습니다.

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc api-resources | grep Deployment
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
deployments                       deploy       apps/v1                                true         Deployment
----

`CustomResourceDefinition`은 Kubernetes `api-resources`의 하위 집합입니다.  클러스터에 이미 CRD가 설치되어 있는지 확인해 보겠습니다.


[#get-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc get crds --all-namespaces
----


[.console-output]
[source,bash,subs="+macros,+attributes"]
----
NAME                                                              CREATED AT
alertmanagerconfigs.monitoring.coreos.com                         2021-07-12T01:37:49Z
alertmanagers.monitoring.coreos.com                               2021-07-12T01:37:53Z
apiservers.config.openshift.io                                    2021-07-12T01:37:06Z
authentications.config.openshift.io                               2021-07-12T01:37:06Z
authentications.operator.openshift.io                             2021-07-12T01:37:53Z
baremetalhosts.metal3.io                                          2021-07-12T01:38:25Z
builds.config.openshift.io                                        2021-07-12T01:37:06Z
catalogsources.operators.coreos.com                               2021-07-12T01:37:49Z
cloudcredentials.operator.openshift.io                            2021-07-12T01:37:10Z
... #<.>
----
NOTE: <.> 이 목록은 잘렸습니다.


OpenShift는 Kubernetes의 핵심입니다.  OpenShift가 Kubernetes를 확장하는 주요 방법 중 하나는 CRD를 통하는 것입니다. 이는 새로 설치한 후에도 CRD가 그렇게 많이 설치되는 이유를 설명합니다.




=== Example CRD


계속해서 사용자 정의 리소스 정의를 만들어 보겠습니다.  나중에 이 정의에서 생성된 이 사용자 정의 리소스는 우리 운영자가 작업할 리소스가 될 것입니다.  우리가 만들 CRD가 어떤 모습인지 보려면 `{quick-open-file}`을 살펴보세요.


[source, yaml]
.{quick-open-file}
----
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: pizzas.mykubernetes.acme.org
  labels:
    app: pizzamaker
    mylabel: stuff
spec:
  group: mykubernetes.acme.org
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: "A custom resource for making yummy pizzas" #<.>
        type: object
        properties:
          spec:
            type: object
            description: "Information about our pizza"
            properties:
              toppings: #<.>
                type: array
                items:
                  type: string
                description: "List of toppings for our pizza"
              sauce: #<.>
                type: string
                description: "The name of the sauce to use on our pizza"
  names:
    kind: Pizza #<.>
    listKind: PizzaList
    plural: pizzas
    singular: pizza
    shortNames:
    - pz
----
NOTE: 
<1> 누군가 CRD를 설명하려고 할 때 표시되는 설명입니다.
<2> 이는 `CustomResource`가 갖게 될 값 중 하나, 즉 (`string`) 토핑의 (`배열`) 목록을 설명합니다.
<3> 이는 `CustomResource`가 사양에서 정의할 수 있는 두 번째 필드, 사용할 소스의 (`문자열`) 이름을 설명합니다.
<4> 이것이 CustomResources의 이름입니다.  일종의 '배포' 또는 '포드'와 같습니다.

[IMPORTANT]
====
많은 CRD에는 Kubernetes API로 CR의 유효성을 검사할 수 있도록 노출되는 필드에 대한 메타데이터가 포함되어 있습니다.API 버전 `v1` 이전에는 이것이 적용되지 않았습니다. Kubernetes v1.22 이후에는 모든 `CustomResources`가 `v1`이어야 하므로 객체 스키마를 정의해야 합니다.
====

이제 `피자` 사용자 정의 리소스를 생성할 수 있도록 이 CRD를 클러스터에 추가해 보겠습니다.

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | oc create -f -
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: pizzas.mykubernetes.acme.org
  labels:
    app: pizzamaker
    mylabel: stuff
spec:
  group: mykubernetes.acme.org
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: "A custom resource for making yummy pizzas"
        type: object
        properties:
          spec:
            type: object
            description: "Information about our pizza"
            properties:
              toppings:
                type: array
                items:
                  type: string
                description: "List of toppings for our pizza"
              sauce:
                type: string
                description: "The name of the sauce to use on our pizza"
  names:
    kind: Pizza
    listKind: PizzaList
    plural: pizzas
    singular: pizza
    shortNames:
    - pz
EOF
----

이제 CRD가 API의 일부임을 확인할 수 있습니다.

[#get-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc get crds | grep pizza
----

결과값:

[.console-output]
[source,bash]
----
NAME                           CREATED AT
pizzas.mykubernetes.acme.org   2024-07-01T08:12:00Z
----

그리고 CRD는 모든 'api-resources'의 하위 집합이므로 이제 'pizzas'가 클러스터의 api-resources를 확장하는 것으로 표시됩니다.

[#get-api-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc api-resources | grep pizzas
----


[.console-output]
[source,bash]
----
pizzas                            pz           mykubernetes.acme.org          true         Pizza
----

마지막으로 'CustomResourceDefinition'에 대한 스키마를 정의한 이후로 사람들이 API를 더 쉽게 사용할 수 있게 되었습니다.  CRD는 'kubectl explain' 기능에 연결됩니다.

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc explain pizza
----

우리에게 유용한 결과를 제공합니다

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
KIND:     Pizza
VERSION:  mykubernetes.acme.org/v1

DESCRIPTION:
     A custom resource for making yummy pizzas #<.>

FIELDS:
   apiVersion   <string>
     APIVersion defines the versioned schema of this representation of an
     object. Servers should convert recognized schemas to the latest internal
     value, and may reject unrecognized values. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

   kind <string>
     Kind is a string value representing the REST resource this object
     represents. Servers may infer this from the endpoint the client submits
     requests to. Cannot be updated. In CamelCase. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

   metadata     <Object>
     Standard object's metadata. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

   sauce        <string> #<.>
     The name of the sauce to use on our pizza

   toppings     <[]string> #<.>
     List of toppings for our pizza'
----
NOTE: 
<.> 이는 피자에 대한 전반적인 설명과 일치합니다.
<.> 이는 소스 CRD의 스키마 섹션에서 가져온 것입니다.  문자열이라고 하네요.  설명은 설명 필드에서 나옵니다.
<.> 이는 토핑에 대한 CRD의 스키마 섹션에서 가져온 것입니다.  문자열의 배열이라고 합니다.  설명은 설명 필드에서 나옵니다.


=== Deploying the Operator

우리의 CRD는 특정 네임스페이스로 제한되지 않지만 '피자' CR에서 작동할 Operator를 배치할 네임스페이스가 필요합니다. 

기본적으로 운영자는 이전에 배포한 'myboot' 애플리케이션과 같은 애플리케이션일 뿐입니다.
차이점은 운영자가 Kubernetes API와 상호 작용하고 관심 있는 리소스를 감시하는 방법을 알고 있다는 것입니다.

:quick-open-file: PizzaResourceWatcher.java

우리가 배포하려는 Pizza 연산자는 https://github.com/java-operator-sdk/java-operator-sdk 링크를 사용하여 https://quarkus.io/[Quarkus^] 링크에 작성되었습니다.  [자바 연산자 SDK^].  이 연산자의 코드는 이 저장소에 있습니다.  운영자 컨트롤러의 주요 클래스 중 하나인 `{quick-open-file}`을 참조하세요.


[.console-output]
[source,java,subs="+macros,+attributes"]
.{quick-open-file}
----
package org.acme;

import io.fabric8.kubernetes.api.model.ContainerBuilder;
import io.fabric8.kubernetes.api.model.ObjectMetaBuilder;
import io.fabric8.kubernetes.api.model.Pod;
import io.fabric8.kubernetes.api.model.PodBuilder;
import io.fabric8.kubernetes.api.model.PodSpecBuilder;
import io.fabric8.kubernetes.client.KubernetesClient;
import io.fabric8.kubernetes.client.KubernetesClientException;
import io.fabric8.kubernetes.client.Watcher;
import io.fabric8.kubernetes.client.dsl.NonNamespaceOperation;
import io.fabric8.kubernetes.client.dsl.Resource;
import io.quarkus.runtime.StartupEvent;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.enterprise.event.Observes;
import javax.inject.Inject;

public class PizzaResourceWatcher {

    @Inject
    KubernetesClient defaultClient;

    @Inject
    NonNamespaceOperation<PizzaResource, PizzaResourceList, PizzaResourceDoneable, Resource<PizzaResource, PizzaResourceDoneable>> crClient;

    void onStartup(@Observes StartupEvent event) {
        System.out.println("Startup");
        crClient.watch(new Watcher<PizzaResource>() { //<.>
            @Override
            public void eventReceived(Action action, PizzaResource resource) {
                System.out.println("Event " + action.name());
                if (action == Action.ADDED) {
                    final String app = resource.getMetadata().getName();
                    final String sauce = resource.getSpec().getSauce();
                    final List<String> toppings = resource.getSpec().getToppings();
                    final Map<String, String> labels = new HashMap<>();
                    labels.put("app", app);
                    final ObjectMetaBuilder objectMetaBuilder = new ObjectMetaBuilder().withName(app + "-pod")
                            .withNamespace(resource.getMetadata().getNamespace()).withLabels(labels);
                    final ContainerBuilder containerBuilder = new ContainerBuilder().withName("pizza-maker")
                            .withImage("quay.io/lordofthejars/pizza-maker:1.0.0").withCommand("/work/application")
                            .withArgs("--sauce=" + sauce, "--toppings=" + String.join(",", toppings));
                    final PodSpecBuilder podSpecBuilder = new PodSpecBuilder().withContainers(containerBuilder.build())
                            .withRestartPolicy("Never");
                    final PodBuilder podBuilder = new PodBuilder().withMetadata(objectMetaBuilder.build())
                            .withSpec(podSpecBuilder.build());
                    final Pod pod = podBuilder.build();
                    defaultClient.resource(pod).createOrReplace();

                }
            }

            @Override
            public void onClose(KubernetesClientException e) {
            }
        });
    }

}
----
NOTE: 
<.> 'Pizza'라는 사용자 정의 리소스를 감시하고 있다는 점에 유의하세요.

[TIP]
====
운영자 컨트롤러 생성은 이 튜토리얼의 범위를 벗어납니다.Quarkus를 사용하여 연산자를 생성하는 방법에 대해 자세히 알아보려면 링크를 시청하세요: https://bit.ly/3kwJmcd[20분 튜토리얼^]
====

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | oc create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: quarkus-operator-example
rules:
- apiGroups:
  - ''
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - delete
  - patch
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - list
- apiGroups:
  - mykubernetes.acme.org
  resources:
  - pizzas
  verbs:
  - list
  - watch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: quarkus-operator-example
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: quarkus-operator-example
subjects:
- kind: ServiceAccount
  name: quarkus-operator-example
  namespace: pizzahat
roleRef:
  kind: ClusterRole
  name: quarkus-operator-example
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: quarkus-operator-example
spec:
  selector:
    matchLabels:
      app: quarkus-operator-example
  replicas: 1
  template:
    metadata:
      labels:
        app: quarkus-operator-example
    spec:
      serviceAccountName: quarkus-operator-example
      containers:
      - image: quay.io/rhdevelopers/pizza-operator:1.0.1
        name: quarkus-operator-example
        imagePullPolicy: IfNotPresent
EOF
----

곧  (*Terminal#2*)에 다음과 같은 내용이 표시됩니다.


[.console-output]
[source,bash,subs="+macros,+attributes"]
----
NAME                                        READY   STATUS    RESTARTS   AGE
quarkus-operator-example-5f5bf777bc-glfg9   1/1     Running   0          58s
----


[IMPORTANT]
====
다음 섹션으로 넘어가기 전에 운영자의 배포 'STATUS'가 'Running'이 될 때까지 기다리세요.
====


=== Make some Pizzas

운영자가 실행되면 '피자' 사용자 정의 리소스에서 정보를 찾고 이를 사용하여 사용자 정의 리소스 인스턴스의 정보로 구성된 포드를 회전시켜 피자를 만드는 척합니다.

예를 들어 Pizza `CustomResourceDefinition`의 인스턴스를 생각해 보세요.

[.console-output]
[source,yaml,subs="+macros,+attributes"]
----
apiVersion: mykubernetes.acme.org/v1
kind: Pizza
metadata:
  name: cheesep
spec:
  toppings:
  - mozzarella
  sauce: regular
----

다음에 특별한 주의를 기울이십시오:

* *Sauce*: `regular`
* *Toppings*: `mozzarella`

이제 이 `CustomResource`를 만들어 보겠습니다.

[#create-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | oc create -f -
apiVersion: mykubernetes.acme.org/v1
kind: Pizza
metadata:
  name: cheesep
spec:
  toppings:
  - mozzarella
  sauce: regular
EOF
----

[#create-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc get pizzas
----


[.console-output]
[source,bash]
----
NAME      AGE
cheesep   4s
----

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc describe pizza cheesep
----

[.console-output]
[source,bash,subs="+attributes"]
----
Name:         cheesep
Namespace:    {section-namespace}
Labels:       <none>
Annotations:  kubectl.kubernetes.io/last-applied-configuration:
                {"apiVersion":"mykubernetes.acme.org/v1beta2","kind":"Pizza","metadata":{"annotations":{},"name":"cheesep","namespace":"{section-namespace}"},"spec":...
API Version:  mykubernetes.acme.org/v1beta2
Kind:         Pizza
...
----

그리고 *{watch-terminal}*에서 Operator가 어떻게 반응하는지 확인해야 합니다.

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
NAME                                        READY   STATUS      RESTARTS   AGE
cheesep-pod                                 0/1     Completed   0          3s
quarkus-operator-example-5f5bf777bc-glfg9   1/1     Running     0          44m
----


그리고 `cheesep-pod`가 완료되면 *{log-terminal}*에 다음이 표시됩니다.


[.console-output]
[source,bash,subs="+quotes,+macros"]
----
+ cheesep-pod › pizza-maker
pass:[cheesep-pod pizza-maker __  ____  __  _____   ___  __ ____  ______ ]
pass:[cheesep-pod pizza-maker  --/ __ \/ / / / _ | / _ \/ //_/ / / / __/ ]
pass:[cheesep-pod pizza-maker  -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\ \   ]
pass:[cheesep-pod pizza-maker --\___\_\____/_/ |_/_/|_/_/|_|\____/___/   ]
cheesep-pod pizza-maker 2021-07-19 08:16:26,113 INFO  [io.quarkus] (main) pizza-maker 1.0-SNAPSHOT (powered by Quarkus 1.4.0.CR1) started in 1.063s. 
cheesep-pod pizza-maker 2021-07-19 08:16:26,114 INFO  [io.quarkus] (main) Profile prod activated. 
cheesep-pod pizza-maker 2021-07-19 08:16:26,114 INFO  [io.quarkus] (main) Installed features: [cdi]
cheesep-pod pizza-maker Doing The Base
cheesep-pod pizza-maker Adding Sauce #regular#
cheesep-pod pizza-maker Adding Toppings #[mozzarella]#
cheesep-pod pizza-maker Baking
cheesep-pod pizza-maker Baked
cheesep-pod pizza-maker Ready For Delivery
cheesep-pod pizza-maker 2021-07-19 08:16:26,615 INFO  [io.quarkus] (main) pizza-maker stopped in 0.000s
----


*소스* 및 *토핑*은 '피자' CustomResource에 지정된 것과 일치합니다.


=== Make more Pizzas



소스와 토핑 옵션을 보려면 `{quick-open-file}` 및 `veggie-lovers.yaml`을 살펴보세요.


[.console-output]
[source,yaml,subs="+macros,+attributes"]
.{quick-open-file}
----
apiVersion: mykubernetes.acme.org/v1
kind: Pizza
metadata:
  name: meatsp
spec:
  toppings:
  - mozzarella
  - pepperoni
  - sausage
  - bacon
  sauce: extra

apiVersion: mykubernetes.acme.org/v1
kind: Pizza
metadata:
  name: veggiep
spec:
  toppings:
  - mozzarella
  - black olives
  sauce: extra
----

이제 피자를 만들어 보세요

[#create-more-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | oc create -f -
apiVersion: mykubernetes.acme.org/v1
kind: Pizza
metadata:
  name: meatsp
spec:
  toppings:
  - mozzarella
  - pepperoni
  - sausage
  - bacon
  sauce: extra
EOF
----

[#create-more-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | oc create -f -
apiVersion: mykubernetes.acme.org/v1
kind: Pizza
metadata:
  name: veggiep
spec:
  toppings:
  - mozzarella
  - black olives
  sauce: extra
EOF
----

[#create-more-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc get pizzas --all-namespaces
----

*{watch-terminal}*의 Pod가 아래와 같이 표시되어야 합니다.

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
NAME                                      READY  STATUS             AGE    NODE
cheesep-pod                               0/1    Completed          8m46s  devnation
meatsp-pod                                0/1    ContainerCreating  8s     devnation
quarkus-operator-example-fdb76c946-cwmnq  1/1    Running            14m    devnation
veggiep-pod                               0/1    ContainerCreating  6s     devnation
----


그리고 로그 터미널 *{log-terminal}*에 이 알림이 표시됩니다.


[.console-output]
[source,bash,subs="+macros,+attributes,+quotes"]
----
+ meatsp-pod › pizza-maker
pass:[meatsp-pod pizza-maker __  ____  __  _____   ___  __ ____  ______ ]
pass:[meatsp-pod pizza-maker  --/ __ \/ / / / _ | / _ \/ //_/ / / / __/ ]
pass:[meatsp-pod pizza-maker  -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\ \   ]
pass:[meatsp-pod pizza-maker --\___\_\____/_/ |_/_/|_/_/|_|\____/___/   ]
meatsp-pod pizza-maker 2021-07-19 08:24:48,015 INFO  [io.quarkus] (main) pizza-maker 1.0-SNAPSHOT (powered by Quarkus 1.4.0.CR1) started in 0.817s. 
meatsp-pod pizza-maker 2021-07-19 08:24:48,016 INFO  [io.quarkus] (main) Profile prod activated. 
meatsp-pod pizza-maker 2021-07-19 08:24:48,016 INFO  [io.quarkus] (main) Installed features: [cdi]
meatsp-pod pizza-maker Doing The Base
meatsp-pod pizza-maker Adding Sauce #extra# #<.>
meatsp-pod pizza-maker Adding Toppings #[mozzarella,pepperoni,sausage,bacon]#
meatsp-pod pizza-maker Baking
meatsp-pod pizza-maker Baked
meatsp-pod pizza-maker Ready For Delivery
meatsp-pod pizza-maker 2021-07-19 08:24:48,517 INFO  [io.quarkus] (main) pizza-maker stopped in 0.000s
+ veggiep-pod › pizza-maker
pass:[veggiep-pod pizza-maker __  ____  __  _____   ___  __ ____  ______ ]
pass:[veggiep-pod pizza-maker  --/ __ \/ / / / _ | / _ \/ //_/ / / / __/ ]
pass:[veggiep-pod pizza-maker  -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\ \   ]
pass:[veggiep-pod pizza-maker --\___\_\____/_/ |_/_/|_/_/|_|\____/___/   ]
veggiep-pod pizza-maker 2021-07-19 08:24:55,289 INFO  [io.quarkus] (main) pizza-maker 1.0-SNAPSHOT (powered by Quarkus 1.4.0.CR1) started in 0.869s. 
veggiep-pod pizza-maker 2021-07-19 08:24:55,289 INFO  [io.quarkus] (main) Profile prod activated. 
veggiep-pod pizza-maker 2021-07-19 08:24:55,289 INFO  [io.quarkus] (main) Installed features: [cdi]
veggiep-pod pizza-maker Doing The Base
veggiep-pod pizza-maker Adding Sauce #extra# #<.>
veggiep-pod pizza-maker Adding Toppings #[mozzarella,black olives]#
veggiep-pod pizza-maker Baking
veggiep-pod pizza-maker Baked
veggiep-pod pizza-maker Ready For Delivery
veggiep-pod pizza-maker 2021-07-19 08:24:55,790 INFO  [io.quarkus] (main) pizza-maker stopped in 0.000s
----
<.> 미트피자 CR의 '소스', '토핑' 일치
<.> 채식주의자 CR의 '소스'와 '토핑'이 일치합니다.


=== Cleanup

네임스페이스의 모든 것을 정리합시다.

[#delete-pizzas-crds]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete all --all #<.>
oc delete ns operator-%userid%
----
TIP:
<.> 네임스페이스는 그 안에 있는 리소스를 자동으로 정리하는 경향이 있지만 '종료자' 문제가 없는지 확인하기 위해 먼저 네임스페이스를 비우는 것이 일반적으로 좋습니다.

[.console-output]
[source,bash]
----
pizza.mykubernetes.acme.org "cheesep" deleted
pizza.mykubernetes.acme.org "meatsp" deleted
pizza.mykubernetes.acme.org "veggiep" deleted
pod "cheesep-pod" deleted
pod "meatsp-pod" deleted
pod "quarkus-operator-example-fdb76c946-cwmnq" deleted
pod "veggiep-pod" deleted
deployment.apps "quarkus-operator-example" deleted
namespace "pizzahat" deleted
----

마지막으로 CRD(`section-namespace`와 같은 특정 네임스페이스에 바인딩되지 않음)를 제거해 보겠습니다.

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete crd pizzas.mykubernetes.acme.org #<.>
----
TIP: 
<.> crd를 삭제할 때 완전한 이름으로 참조해야 합니다.

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
customresourcedefinition.apiextensions.k8s.io "pizzas.mykubernetes.acme.org" deleted
----

== Create some Kafka

https://github.com/strimzi/strimzi-kafka-operator/blob/master/install/cluster-operator/040-Crd-kafka.yaml[Example CRD]




=== Kafka for OpenShift

image::2-10.png[2-10]

=== Verify Install

[#verify-install]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc get csv -n operators
oc get crds | grep kafka
----

다른 터미널에서 watch를 시작하십시오.

[#watch-pods]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
watch oc get pods
----

그런 다음 Kafka 클러스터를 요청하는 리소스를 배포합니다.

[#deploy-cluster]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
cat <<EOF | oc create -f -
apiVersion: kafka.strimzi.io/v1alpha1
kind: Kafka
metadata: 
  name: my-cluster
spec:
  kafka:
    replicas: 3
    listeners:
      external:
        type: nodeport
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
EOF
----

[.console-output]
[source,bash]
----
NAME                                          READY   STATUS    RESTARTS   AGE
my-cluster-entity-operator-66676cb9fb-fzckz   2/2     Running   0          29s
my-cluster-kafka-0                            2/2     Running   0          60s
my-cluster-kafka-1                            2/2     Running   0          60s
my-cluster-kafka-2                            2/2     Running   0          60s
my-cluster-zookeeper-0                        2/2     Running   0          92s
my-cluster-zookeeper-1                        2/2     Running   0          92s
my-cluster-zookeeper-2                        2/2     Running   0          92s
----

Kafka에서 모든 정보를 얻을 수 있습니다.

[#get-kafkas-crd]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc get kafkas
----

[.console-output]
[source,bash]
----
NAME         DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS
my-cluster   3                        3
----

=== Clean up

[#clean-up]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete namespace {section-namespace}
oc delete -f apps/pizzas/pizza-crd.yaml
oc delete kafka my-cluster
oc delete namespace franz
----

